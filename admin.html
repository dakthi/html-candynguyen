<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - candy.nguyen.5832</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Verdana, Arial, sans-serif;
            background: #e9ecef url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><rect fill="%23dde3e9" width="20" height="20"/><circle fill="%23c8d2db" cx="10" cy="10" r="1" opacity="0.5"/></svg>');
            color: #333;
            font-size: 11px;
        }

        .blog {
            max-width: 900px;
            margin: 20px auto;
            background: white;
            border: 1px solid #999;
        }

        .header {
            background: linear-gradient(to bottom, #6699cc 0%, #4477aa 100%);
            color: white;
            padding: 15px 20px;
            border-bottom: 3px solid #336699;
        }

        .header table {
            width: 100%;
            border-collapse: collapse;
        }

        .header h1 {
            font-size: 18px;
            font-weight: normal;
            margin: 0;
        }

        .header-links {
            text-align: right;
            font-size: 10px;
        }

        .header-links a, .header-links button {
            color: white;
            text-decoration: underline;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 10px;
            font-family: Verdana, Arial, sans-serif;
            margin-left: 10px;
        }

        .content {
            padding: 15px;
        }

        .admin-box {
            background: #f5f5f5;
            border: 2px solid #336699;
            padding: 15px;
            margin-bottom: 15px;
        }

        .admin-box h2 {
            font-size: 14px;
            color: #336699;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px dotted #336699;
        }

        table.posts-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border: 1px solid #999;
        }

        table.posts-table th {
            background: #336699;
            color: white;
            padding: 8px;
            text-align: left;
            font-size: 10px;
            font-weight: bold;
        }

        table.posts-table td {
            padding: 8px;
            border-bottom: 1px solid #ddd;
            font-size: 10px;
        }

        table.posts-table tr:hover {
            background: #f9f9f9;
        }

        .btn {
            padding: 4px 10px;
            font-size: 10px;
            border: 1px solid #336699;
            background: white;
            color: #336699;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-family: Verdana, Arial, sans-serif;
        }

        .btn:hover {
            background: #336699;
            color: white;
        }

        .btn-primary {
            background: #336699;
            color: white;
            font-weight: bold;
        }

        .btn-primary:hover {
            background: #4477aa;
        }

        .btn-danger {
            border-color: #c44;
            color: #c44;
        }

        .btn-danger:hover {
            background: #c44;
            color: white;
            border-color: #c44;
        }

        .form-table {
            width: 100%;
            border-collapse: collapse;
        }

        .form-table td {
            padding: 8px;
            vertical-align: top;
        }

        .form-table label {
            font-size: 10px;
            font-weight: bold;
            display: block;
            margin-bottom: 3px;
        }

        .form-table input[type="text"],
        .form-table input[type="datetime-local"],
        .form-table textarea,
        .form-table select {
            width: 100%;
            padding: 5px;
            border: 1px solid #999;
            background: white;
            font-family: Verdana, Arial, sans-serif;
            font-size: 11px;
        }

        .form-table textarea {
            min-height: 150px;
            resize: vertical;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 3px solid #336699;
            max-width: 650px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            background: #336699;
            color: white;
            padding: 10px 15px;
        }

        .modal-header h2 {
            font-size: 14px;
            font-weight: bold;
            float: left;
        }

        .modal-close {
            float: right;
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
        }

        .modal-body {
            padding: 15px;
        }

        .status-box {
            padding: 8px;
            margin-bottom: 10px;
            border: 2px solid;
            font-size: 10px;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #bee5eb;
        }

        .footer {
            background: #f5f5f5;
            padding: 10px;
            border-top: 1px solid #ddd;
            text-align: center;
            font-size: 10px;
            color: #666;
        }

        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .main-layout {
            display: flex;
            align-items: stretch;
        }

        .sidebar {
            width: 180px;
            background: #f5f5f5;
            border-left: 1px solid #ddd;
            padding: 15px;
            font-size: 11px;
        }

        .sidebar h3 {
            font-size: 12px;
            color: #336699;
            margin: 0 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #ccc;
        }

        .sidebar ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .sidebar li {
            margin-bottom: 6px;
        }

        .sidebar a {
            color: #336699;
            text-decoration: none;
        }

        .sidebar a:hover {
            text-decoration: underline;
        }

        .hamburger {
            display: none;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            right: 15px;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hamburger span {
            display: block;
            width: 25px;
            height: 3px;
            background: white;
            margin: 5px 0;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .overlay.active {
            display: block;
        }

        body.sidebar-open {
            overflow: hidden;
        }

        .save-status-header {
            font-size: 10px;
            color: white;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .blog {
                margin: 0;
                border: none;
            }

            .main-layout {
                flex-direction: column;
            }

            .header {
                position: relative;
            }

            .header h1 {
                font-size: 14px;
                padding-right: 50px;
            }

            .hamburger {
                display: block;
            }

            .sidebar {
                position: fixed;
                top: 0;
                right: -200px;
                width: 200px;
                height: 100vh;
                z-index: 1000;
                transition: right 0.3s ease;
                box-shadow: -2px 0 5px rgba(0,0,0,0.2);
                overflow-y: auto;
            }

            .sidebar.active {
                right: 0;
            }

            .content {
                padding: 15px 10px;
            }

            .admin-box {
                padding: 10px;
                margin-bottom: 10px;
            }

            table.posts-table {
                font-size: 10px;
            }

            table.posts-table th,
            table.posts-table td {
                padding: 5px 3px;
            }

            /* Hide mood column on mobile */
            table.posts-table th:nth-child(3),
            table.posts-table td:nth-child(3) {
                display: none;
            }

            .btn {
                padding: 4px 6px;
                font-size: 9px;
                margin: 2px 0;
                display: block;
                width: 100%;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab {
                font-size: 10px;
                padding: 6px 10px;
            }

            .form-table {
                font-size: 10px;
            }

            .form-table input,
            .form-table textarea,
            .form-table select {
                font-size: 11px;
            }

            .modal-content {
                width: 95%;
                max-height: 90vh;
            }
        }
    </style>
</head>
<body>
    <div class="overlay" id="overlay"></div>

    <div class="blog">
        <div class="header">
            <button class="hamburger" id="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <h1>candy.nguyen.5832 - Admin Panel</h1>
            <div class="save-status-header">
                <span id="save-status"></span>
            </div>
        </div>

        <div class="main-layout">
            <div class="content">
            <div id="status-container"></div>

            <!-- Posts List -->
            <div class="admin-box">
                <h2>¬ª Qu·∫£n l√Ω b√†i vi·∫øt</h2>
                <p style="margin-bottom: 10px; font-size: 10px;">
                    <button class="btn btn-primary" onclick="showNewPostForm()">+ Th√™m b√†i m·ªõi</button>
                </p>
                <p style="margin-bottom: 15px;">
                    <input type="text" id="adminSearchBox" placeholder="T√¨m ki·∫øm b√†i vi·∫øt..." style="width: 100%; max-width: 400px; padding: 8px; border: 1px solid #ccc; font-size: 11px; font-family: Verdana, Arial, sans-serif;">
                </p>
                <div class="table-wrapper">
                    <table class="posts-table" id="posts-table">
                        <thead>
                            <tr>
                                <th width="50%">Ti√™u ƒë·ªÅ</th>
                                <th width="20%">Ng√†y ƒëƒÉng</th>
                                <th width="15%">Mood</th>
                                <th width="15%">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="posts-list">
                            <tr><td colspan="4" align="center">ƒêang t·∫£i...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- New Post Form (hidden by default) -->
            <div id="new-post-box" class="admin-box" style="display:none;">
                <h2>¬ª Th√™m b√†i vi·∫øt m·ªõi</h2>
                <form id="new-post-form">
                    <table class="form-table">
                        <tr>
                            <td width="20%"><label>Ti√™u ƒë·ªÅ:</label></td>
                            <td><input type="text" id="new-title" required></td>
                        </tr>
                        <tr>
                            <td valign="top"><label>N·ªôi dung:</label></td>
                            <td><textarea id="new-text" required></textarea></td>
                        </tr>
                        <tr>
                            <td><label>Mood:</label></td>
                            <td>
                                <select id="new-mood">
                                    <option value="">Kh√¥ng c√≥ mood</option>
                                    <option value="‚ù§Ô∏è c·∫£m th·∫•y bi·∫øt ∆°n">‚ù§Ô∏è c·∫£m th·∫•y bi·∫øt ∆°n</option>
                                    <option value="üòä c·∫£m th·∫•y vui v·∫ª">üòä c·∫£m th·∫•y vui v·∫ª</option>
                                    <option value="ü§£ c·∫£m th·∫•y bu·ªìn c∆∞·ªùi">ü§£ c·∫£m th·∫•y bu·ªìn c∆∞·ªùi</option>
                                    <option value="üíï c·∫£m th·∫•y y√™u th∆∞∆°ng">üíï c·∫£m th·∫•y y√™u th∆∞∆°ng</option>
                                    <option value="üìù c·∫£m th·∫•y mu·ªën chia s·∫ª">üìù c·∫£m th·∫•y mu·ªën chia s·∫ª</option>
                                    <option value="üòå c·∫£m th·∫•y b√¨nh y√™n">üòå c·∫£m th·∫•y b√¨nh y√™n</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td></td>
                            <td>
                                <button type="submit" class="btn btn-primary">T·∫°o b√†i vi·∫øt</button>
                                <button type="button" class="btn" onclick="hideNewPostForm()">H·ªßy</button>
                            </td>
                        </tr>
                    </table>
                </form>
            </div>
        </div>

        <div class="sidebar" id="sidebar">
            <h3>Qu·∫£n l√Ω</h3>
            <ul>
                <li><a href="index.html">Trang ch·ªß</a></li>
                <li><a href="#" onclick="logout(); return false;">ƒêƒÉng xu·∫•t</a></li>
            </ul>
        </div>
        </div>

        <div class="footer">
            built by Thi - a Charted consultant
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ch·ªânh s·ª≠a b√†i vi·∫øt</h2>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
                <div style="clear:both;"></div>
            </div>
            <div class="modal-body">
                <form id="edit-form">
                    <input type="hidden" id="edit-post-id">
                    <table class="form-table">
                        <tr>
                            <td width="20%"><label>Ti√™u ƒë·ªÅ:</label></td>
                            <td><input type="text" id="edit-title" required></td>
                        </tr>
                        <tr>
                            <td valign="top"><label>N·ªôi dung ƒë·∫ßy ƒë·ªß:</label></td>
                            <td><textarea id="edit-text" required></textarea></td>
                        </tr>
                        <tr>
                            <td><label>Mood:</label></td>
                            <td>
                                <select id="edit-mood">
                                    <option value="">Kh√¥ng c√≥ mood</option>
                                    <option value="‚ù§Ô∏è c·∫£m th·∫•y bi·∫øt ∆°n">‚ù§Ô∏è c·∫£m th·∫•y bi·∫øt ∆°n</option>
                                    <option value="üòä c·∫£m th·∫•y vui v·∫ª">üòä c·∫£m th·∫•y vui v·∫ª</option>
                                    <option value="ü§£ c·∫£m th·∫•y bu·ªìn c∆∞·ªùi">ü§£ c·∫£m th·∫•y bu·ªìn c∆∞·ªùi</option>
                                    <option value="üíï c·∫£m th·∫•y y√™u th∆∞∆°ng">üíï c·∫£m th·∫•y y√™u th∆∞∆°ng</option>
                                    <option value="üìù c·∫£m th·∫•y mu·ªën chia s·∫ª">üìù c·∫£m th·∫•y mu·ªën chia s·∫ª</option>
                                    <option value="üòå c·∫£m th·∫•y b√¨nh y√™n">üòå c·∫£m th·∫•y b√¨nh y√™n</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td><label>Ng√†y ƒëƒÉng:</label></td>
                            <td><input type="datetime-local" id="edit-time" required></td>
                        </tr>
                        <tr>
                            <td></td>
                            <td>
                                <button type="submit" class="btn btn-primary">L∆∞u thay ƒë·ªïi</button>
                                <button type="button" class="btn" onclick="closeEditModal()">H·ªßy</button>
                            </td>
                        </tr>
                    </table>
                </form>
            </div>
        </div>
    </div>

    <script>
        const REPO = 'dakthi/html-candynguyen';
        const CONTENT_PATH = 'posts_with_images.json';

        let posts = {};
        let contentSha = '';

        // Check auth
        const token = localStorage.getItem('github_token');
        if (!token) {
            window.location.href = 'login.html';
        }

        function showStatus(message, type) {
            const container = document.getElementById('status-container');
            container.innerHTML = `<div class="status-box status-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        function showNewPostForm() {
            document.getElementById('new-post-box').style.display = 'block';
            window.scrollTo(0, document.getElementById('new-post-box').offsetTop - 20);
        }

        function hideNewPostForm() {
            document.getElementById('new-post-box').style.display = 'none';
            document.getElementById('new-post-form').reset();
        }

        async function loadPosts() {
            try {
                const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${CONTENT_PATH}`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                const data = await res.json();

                if (data.content) {
                    contentSha = data.sha;
                    const content = decodeURIComponent(escape(atob(data.content)));
                    posts = JSON.parse(content);
                    renderPosts();
                } else {
                    showStatus('L·ªói: ' + (data.message || 'Kh√¥ng th·ªÉ t·∫£i b√†i vi·∫øt'), 'error');
                }
            } catch (e) {
                showStatus('L·ªói: ' + e.message, 'error');
            }
        }

        function renderPosts() {
            const list = document.getElementById('posts-list');
            const searchTerm = document.getElementById('adminSearchBox').value.toLowerCase();

            let postsArray = Object.entries(posts).sort((a, b) => {
                return new Date(b[1].time) - new Date(a[1].time);
            });

            // Filter by search term if present
            if (searchTerm) {
                postsArray = postsArray.filter(([id, post]) => {
                    const fullText = ((post.title || '') + ' ' + (post.body || '')).toLowerCase();
                    return fullText.includes(searchTerm);
                });
            }

            if (postsArray.length === 0) {
                list.innerHTML = '<tr><td colspan="4" align="center">Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt n√†o</td></tr>';
                return;
            }

            list.innerHTML = postsArray.map(([id, post]) => {
                const date = new Date(post.time).toLocaleDateString('vi-VN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                const title = post.title || '';
                const displayTitle = title.length > 60 ? title.substring(0, 60) + '...' : title;
                const mood = post.mood || '-';

                return `
                    <tr>
                        <td>${displayTitle}</td>
                        <td>${date}</td>
                        <td>${mood}</td>
                        <td>
                            <button class="btn" onclick="editPost('${id}')">S·ª≠a</button>
                            <button class="btn btn-danger" onclick="deletePost('${id}')">X√≥a</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function editPost(postId) {
            const post = posts[postId];

            document.getElementById('edit-post-id').value = postId;
            document.getElementById('edit-title').value = post.title || '';
            document.getElementById('edit-text').value = post.body || '';
            document.getElementById('edit-mood').value = post.mood || '';
            document.getElementById('edit-time').value = new Date(post.time).toISOString().slice(0, 16);
            document.getElementById('edit-modal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }

        async function deletePost(postId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i vi·∫øt n√†y?')) return;

            delete posts[postId];
            await savePosts('X√≥a b√†i vi·∫øt');
        }

        async function savePosts(message = 'C·∫≠p nh·∫≠t b√†i vi·∫øt') {
            try {
                showStatus('ƒêang l∆∞u...', 'info');
                const jsonContent = btoa(unescape(encodeURIComponent(JSON.stringify(posts, null, 2))));

                const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${CONTENT_PATH}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message + ' (qua CMS)',
                        content: jsonContent,
                        sha: contentSha
                    })
                });

                const data = await res.json();
                if (data.content) {
                    contentSha = data.content.sha;
                    showStatus('ƒê√£ l∆∞u! Trang s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t trong v√†i gi√¢y.', 'success');
                    renderPosts();
                    document.getElementById('save-status').textContent = 'L∆∞u l√∫c: ' + new Date().toLocaleTimeString();
                } else {
                    showStatus('L·ªói: ' + (data.message || 'Kh√¥ng th·ªÉ l∆∞u'), 'error');
                }
            } catch (e) {
                showStatus('L·ªói: ' + e.message, 'error');
            }
        }

        // Edit form submit
        document.getElementById('edit-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const postId = document.getElementById('edit-post-id').value;
            const title = document.getElementById('edit-title').value;
            const body = document.getElementById('edit-text').value;
            const mood = document.getElementById('edit-mood').value;
            const time = new Date(document.getElementById('edit-time').value).toISOString();

            // Save title and body separately
            posts[postId].title = title;
            posts[postId].body = body;
            posts[postId].mood = mood || null;
            posts[postId].time = time;

            closeEditModal();
            await savePosts('Ch·ªânh s·ª≠a b√†i vi·∫øt');
        });

        // New post form submit
        document.getElementById('new-post-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const title = document.getElementById('new-title').value;
            const body = document.getElementById('new-text').value;
            const mood = document.getElementById('new-mood').value;

            const newId = Date.now().toString();

            posts[newId] = {
                title: title,
                body: body,
                time: new Date().toISOString(),
                likes: 0,
                comments: 0,
                shares: 0,
                images: [],
                mood: mood || null
            };

            await savePosts('Th√™m b√†i vi·∫øt m·ªõi');
            this.reset();
            showTab('posts');
        });

        function logout() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?')) {
                localStorage.removeItem('github_token');
                window.location.href = 'login.html';
            }
        }

        // Hamburger menu toggle
        const hamburger = document.getElementById('hamburger');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');

        function toggleMenu() {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
            document.body.classList.toggle('sidebar-open');
        }

        function closeSidebar() {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
            document.body.classList.remove('sidebar-open');
        }

        hamburger.addEventListener('click', toggleMenu);
        overlay.addEventListener('click', toggleMenu);

        // Search functionality - real-time filtering
        document.getElementById('adminSearchBox').addEventListener('input', function() {
            renderPosts();
        });

        // Load posts on page load
        loadPosts();
    </script>
</body>
</html>
